<!doctype html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=ylxdzsw@gmail.com><meta charset=utf-8><title>群聊分析 | ylxdzsw's blog</title><style>html{font-family:sans-serif;line-height:1.5;text-align:justify;hyphens:auto;color:#33333d}@media (max-width:625px){html{font-size:15px}}body{max-width:1080px;margin:0 auto;padding:0 1rem}@media (max-width:625px){body{padding:0 .8rem}}h2,h3{margin:2rem 0 0;position:relative}h2:before,h3:before{content:"#";color:#42b983;position:absolute;left:-1rem;top:0;font-weight:700;opacity:0}@media (min-width:625px){h2:hover:before,h3:hover:before{opacity:1}}h2 a,h3 a{color:#2c3e50}h2{font-family:serif;padding-bottom:.7rem;border-bottom:.5px solid #ddd}h2:before{top:.1em;font-size:.9em}pre{border:1px solid #bcd;background-color:#ebf1f5;padding:.8rem;overflow-x:auto}pre code{font-size:.8rem}code{font-family:monospace;color:#222}ul ol{padding-left:1.5rem;margin:1.2rem 0}a{color:#42b983;text-decoration:none}a:hover{text-decoration:underline}blockquote{margin:1.2rem 0;padding:0 1rem;border-left:4px solid #42b983}blockquote.warn{border-left-color:tomato}blockquote p{margin-left:0}</style><style>#interaction{display:block;margin:auto}#interaction .links line{stroke:#999;stroke-opacity:0.6}#interaction .nodes circle{stroke:#fff;stroke-width:1.5px}#interaction text{font-family:sans-serif;font-size:10px;user-select:none}</style><script src=https://d3js.org/d3.v7.min.js></script><label for=bot>交互式机器人id（逗号分隔）:</label> <input id=bot><br><label for=bot2>非交互式机器人id（逗号分隔）:</label> <input id=bot2 value=10000,1000000><br><input id=data type=file name=data><h3><a id=sec0 href=#sec0>Interaction</a></h3><div><svg id=interaction width=800 height=600></svg></div><h3><a id=sec1 href=#sec1>TF-IDF</a></h3><pre id=tfidf></pre><script>class Token{constructor(e){this.value=e}}class BiGram extends Token{is_complete(){return this.value.length>=2}}class English extends Token{constructor(e){super(e),this.value=this.value.toLowerCase()}}function string_to_token(e,t){const n=[],s=new Set(["[图片]","[表情]"]);for(const e of Object.values(t))for(const t in e)s.add("@"+t);for(const t of Array.from(s).sort(((e,t)=>t.length-e.length)))e=e.replaceAll(t," ");const a=e=>/\p{Script=Han}/u.test(e),o=e=>/[a-zA-Z]/u.test(e);let c=null;for(const t of e+"\0")switch(!0){case c instanceof BiGram:switch(c.is_complete()&&n.push(c),!0){case a(t):c=new BiGram((c.value+t).slice(-2));break;case o(t):c=new English(t);break;default:c=null}break;case c instanceof English:switch(!0){case a(t):n.push(c),c=new BiGram(t);break;case o(t):c=new English(c.value+t);break;default:n.push(c),c=null}break;default:switch(!0){case a(t):c=new BiGram(t);break;case o(t):c=new English(t);break;default:c=null}}return n}function parse_header(e){const t=e.match(/^(\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2}) (.*)(\((\d+)\)|<([^<>]+)>)$/);if(null===t)return null;const[,n,s,,a,o]=t;return{time:n,name:s,id:a||o}}function parse(e){const t=Object.create(null),n=[];for(const s of e.split(/\r?\n/)){const e=parse_header(s);if(null==e)0!=n.length&&n[n.length-1].tokens.push(...string_to_token(s,t));else{const{time:s,name:a,id:o}=e;n.push({time:Date.parse(s)/1e3,id:o,tokens:[]}),t[o]=t[o]??Object.create(null),t[o][a]=(t[o][a]??0)+1}}return{aliases:t,messages:n}}function remove_id(e,t,n=!1){const s=e.map((()=>!1));for(let a=0;a<e.length;a++)if(e[a].id==t&&(s[a]=!0,n)){let e=a-1;for(;e>=0&&s[e];)e--;s[e]=!0}return e.filter(((e,t)=>!s[t]))}async function sha256(e){const t=await crypto.subtle.digest("SHA-256",new TextEncoder("utf-8").encode("🐕"+e+"🐶"));return btoa(String.fromCharCode(...new Uint8Array(t)))}const black_list=["k9URW8fQMo2wan1I7CmyAxX9RBISFj3xoNtcbLvQk5M="];async function clean(e,t,n=[],s=[]){for(const n in t)black_list.includes(await sha256(n))&&(e=remove_id(e,n,!1),delete t[n]);for(const s of n)e=remove_id(e,s,!0),delete t[s];for(const n of s)e=remove_id(e,n,!1),delete t[n];return{messages:e,aliases:t}}function detect_session(e,t){const n=[];let s=0;for(const a of e)a.time-s>t&&n.push([]),n[n.length-1].push(a),s=a.time;return n}const sum=e=>e.reduce(((e,t)=>e+t),0),mean=e=>sum(e)/e.length;async function show_interation(e,t){const n=get_representitive_alias(t),s=Object.create(null);for(const t of[30,1800])for(const n of detect_session(e,t)){const e=Object.create(null);for(const{id:t}of n)e[t]=(e[t]??0)+1/n.length;for(const t in e)for(const n in e)t<n&&(s[t]=s[t]??Object.create(null),s[t][n]=(s[t][n]??0)+e[t]*e[n])}const a=[];for(const e in s)for(const t in s[e])s[e][t]>1&&a.push({source:e,target:t,value:s[e][t]});const o=Math.max(...a.map((({value:e})=>e)));for(const e of a)e.value/=o;const c={nodes:Object.keys(t).map(((e,t)=>({id:e,group:t}))),links:a},r=d3.select("svg"),l=+r.attr("width"),i=+r.attr("height"),d=d3.scaleOrdinal(d3.schemeSet1),u=d3.forceSimulation().force("link",d3.forceLink().id((e=>e.id))).force("charge",d3.forceManyBody().strength(-25)).force("center",d3.forceCenter(l/2,i/2)).force("collide",d3.forceCollide().radius(20)),f=r.append("g").attr("class","links").selectAll("line").data(c.links).enter().append("line").attr("stroke-width",(e=>5*e.value)),g=r.append("g").attr("class","nodes").selectAll("g").data(c.nodes).enter().append("g");g.append("circle").attr("r",5).attr("fill",(e=>d(e.group)));d3.drag().on("start",(e=>{u.alphaTarget(.3).restart()})).on("drag",((e,t)=>{t.fx=e.x,t.fy=e.y})).on("end",((e,t)=>{u.alphaTarget(0),t.fx=null,t.fy=null}))(g),g.append("text").text((e=>n[e.id])).attr("x",6).attr("y",3),g.append("title").text((e=>e.id)),u.nodes(c.nodes).on("tick",(()=>{f.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),g.attr("transform",(e=>"translate("+e.x+","+e.y+")"))})),u.force("link").links(c.links).strength((e=>(Math.log(Math.exp(1)+e.value)-1)/10))}const get_representitive_alias=e=>Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Object.entries(t).sort(((e,t)=>t[1]-e[1]))[0][0]]))),get_ids_by_message_count=e=>Object.entries(e).map((([e,t])=>[e,sum(Object.values(t))])).sort(((e,t)=>t[1]-e[1])).map((([e])=>e));function calc_tfidf(e){const t=Object.create(null),n=Object.create(null);for(const{id:s,tokens:a}of e){const e=new Set(a.map((e=>e.value)));t[s]=t[s]??Object.create(null);for(const a of e)t[s][a]=(t[s][a]??0)+1,n[a]=n[a]??new Set,n[a].add(s)}const s=Object.create(null);for(const e in t){s[e]=s[e]??Object.create(null);const a=sum(Object.values(t[e]));for(const o in t[e])n[o].size>1&&(s[e][o]=t[e][o]/a*Math.log(Object.keys(t).length/(n[o].size+1)))}return s}async function show_tfidf(e,t){const n=get_representitive_alias(t),s=calc_tfidf(e);let a="";for(const e of get_ids_by_message_count(t))s[e]&&(a+=n[e]+": "+Object.entries(s[e]).sort(((e,t)=>t[1]-e[1])).slice(0,10).map((([e])=>e)).join(", ")+"\n");document.getElementById("tfidf").innerText=a}async function main(){const e=document.getElementById("data").files[0],t=await e.text();let{messages:n,aliases:s}=parse(t);({messages:n,aliases:s}=await clean(n,s,document.getElementById("bot")?.value.split(",")??[],document.getElementById("bot2")?.value.split(",")??[])),await show_interation(n,s),await show_tfidf(n,s)}async function test(){const e=Deno.readTextFileSync(Deno.args[0]);let{messages:t,aliases:n}=parse(e);({messages:t,aliases:n}=await clean(t,n,Deno.args.slice(1))),console.log(calc_tfidf(t))}"undefined"!=typeof Deno&&test(),"undefined"!=typeof document&&document.getElementById("data").addEventListener("change",main)</script>